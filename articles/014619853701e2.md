---
title: "Fama-French ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼ã‚’æ—¥æœ¬ã®æ ªå¼å¸‚å ´ã§ä½œã‚‹"
emoji: "ğŸ‘»"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["R", "finance", "Investment"]
published: true
---

# 20251030_FamaFrenchFactors_in-Japan

20251031 ä¿®æ­£: authentification ã«é–¢ã™ã‚‹è¨˜è¿°ã¨æœŸé–“æŒ‡å®šã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚

# Disclosure

ã“ã®è¨˜äº‹ã¯æ‰€å±çµ„ç¹”ã¨ã¯ä¸€åˆ‡é–¢ä¿‚ãªãã€å€‹åˆ¥ã®éŠ˜æŸ„ãƒ»æŠ•è³‡è¡“ãªã©ã‚’æ¨å¥¨ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

# Fama French Factor Model ã¨ã¯

ã¿ãšã»ã®ã‚µã‚¤ãƒˆã«ã‚ˆãã¾ã¨ã¾ã£ã¦ã„ã‚‹ã®ã§å¼•ç”¨ã—ã¾ã™ã€‚ãŸã ã€å¾Œè¿°ã—ã¾ã™ãŒã€ã‚µã‚¤ã‚ºã®åˆ†ã‘æ–¹ã®èª¬æ˜ãŒã‚ªãƒªã‚¸ãƒŠãƒ«ã¨ã¡ã‚‡ã£ã¨é•ã†ã‚“ã§ã™ã‚ˆã­ã€‚
https://glossary.mizuho-sc.com/faq/show/1145?site_domain=default

è«–æ–‡ã‚’å…ƒã«ã—ã¦å»ºã¦ã®ãƒªã‚¿ãƒ¼ãƒ³ã‚’ä½¿ã£ãŸãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼ã¯ French æ•™æˆã®ã‚µã‚¤ãƒˆã§å…¬é–‹ã•ã‚Œã¦ã„ã¾ã™ã€‚
https://mba.tuck.dartmouth.edu/pages/faculty/ken.french/index.html

ã“ã‚Œã‚‰ã®ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼ã‚’å«ã‚ã€æœ€è¿‘ã§ã¯ã“ã¡ã‚‰ã®ã‚µã‚¤ãƒˆã§ Yale å¤§å­¦ã®æ•™æˆãŒãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼ãƒªã‚¿ãƒ¼ãƒ³ã‚’å…¬é–‹ã—ã¦ã„ã‚‹ã®ã§ã€ãƒ‰ãƒ«å»ºã¦ã§ã‚‚ã‚ˆã‘ã‚Œã°ã“ã†ã„ã£ãŸãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼ã¯ç°¡å˜ã«å–ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
https://jkpfactors.com/

# Factor ã‚’å†ç¾ã—ãŸã„

ã“ã‚Œã‚‰ã®ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼ã¯ãƒ‰ãƒ«å»ºã¦ãªã®ã§ã€æ—¥æœ¬æ ªãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã®ãƒªã‚¹ã‚¯ãƒ»ãƒªã‚¿ãƒ¼ãƒ³åˆ†æã«ä½¿ã†ã¨ãã¯ãƒã‚¤ã‚ºãŒå¤§ããã¦ä½¿ã„ç‰©ã«ãªã‚Šã¾ã›ã‚“ã€‚ãã“ã§ã€å††å»ºã¦ã®æ—¥æœ¬æ ªæƒ…å ±ã‚’ä½¿ã£ã¦è‡ªåˆ†ã§ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼ã‚’å†ç¾ã—ãŸã„ã¨ã„ã†ã¨ããŒã‚ˆãã‚ã‚Šã¾ã™ã€‚

ä»Šã“ã®è¨˜äº‹ã‚’æ›¸ã„ã¦ã„ã¦æ°—ã¥ãã¾ã—ãŸãŒã€å„ã‚µã‚¤ãƒˆã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼ã«ç‚ºæ›¿ãƒªã‚¿ãƒ¼ãƒ³ã‚’ã‹ã‘ã‚Œã°å††å»ºã¦ã®ãƒªã‚¿ãƒ¼ãƒ³ãŒç°¡å˜ã«æ‰‹ã«å…¥ã‚Šã¾ã™ã­ã€‚ã€‚ã€‚ã¨ã¯ã„ãˆã€ãã‚Œã§ã¯ã“ã®è¨˜äº‹ã®æ„ç¾©ãŒãªããªã£ã¦ã—ã¾ã†ã®ã§ã€ä¸éƒ½åˆãªçœŸå®Ÿã¯ã„ã£ãŸã‚“å¿˜ã‚Œã¾ã—ã‚‡ã†ã€‚

## ã‚µã‚¤ã‚ºãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã®å®šç¾©

å‰è¿°ã® French æ•™æˆã®ã‚µã‚¤ãƒˆã§ã¯ã€ä»¥ä¸‹ã®é€šã‚Šæ­£ç¢ºãªå®šç¾©ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚ç±³å›½ã«ãŠã„ã¦ã¯ä¸­å¤®å€¤ã§ã‚µã‚¤ã‚ºãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‚’åˆ†ã‘ã¦ã„ã¾ã™ã€‚
\> The size breakpoint for year t is the median NYSE market equity at
the end of June of year t.

ã“ã‚Œã‚‰ã®è«–æ–‡ã«ã¦æ—¥æœ¬æ ªã«ãŠã„ã¦ãƒ•ã‚¡ãƒ¼ãƒãƒ•ãƒ¬ãƒ³ãƒã®æœ‰åŠ¹æ€§ã‚’æ¤œè¨¼ã—ã¦ã„ã‚‹ã®ã§ã€ä»Šå›ã¯ã“ã¡ã‚‰ã«ã—ãŸãŒã£ã¦ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‚’ä½œã£ã¦ã€ãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼ã‚’å†ç¾ã—ã¦ã„ãã¾ã™ã€‚
https://www.jstage.jst.go.jp/article/gendaifinance/22/0/22_3/\_article/-char/ja/

ä»Šå›ã¯ã‚³ãƒ¼ãƒ‰ã®ç´¹ä»‹è¨˜äº‹ãªã®ã§ã€ã•ã£ãããƒ€ãƒ©ãƒ€ãƒ©ã¨æ›¸ã„ã¦è¡Œãã¾ã™ã€‚ã‹ãªã‚Šè¨˜äº‹ãŒé•·ããªã‚Šãã†ãªã®ã§ã€åˆ†å‰²ã—ã¦æŠ•ç¨¿ã—ã¦ã„ãã¾ã™ã€‚

# ã‚³ãƒ¼ãƒ‰

## ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ¼èª­ã¿è¾¼ã¿ã¨ãƒ‡ãƒ¼ã‚¿å–å¾—

ã“ã‚Œã‚‰ã®è¨˜äº‹ã‚’å‚è€ƒã«ã€R ã§ J-Quant ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹é–¢æ•°ã‚’æ›¸ã„ã¦ã„ãã¾ã™ã€‚äº‹å‰ã« J-Quant ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã—ã¦ã€Refresh
token ã‚’ç™ºè¡Œã™ã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚åƒ•ã¯ã€`authinfo.r`ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã«èªè¨¼æƒ…å ±ã‚’ä»¥ä¸‹ã®å½¢ã§å…¥ã‚Œã¦ã‚ã‚Šã¾ã™ã€‚

```r
jquant <- list(
    mailaddress = "xxx@yyy.com",
    password = "xxxyyyzzz"
)

slack_url <- "https://hooks.slack.com/services/xxxxxxxx"
```

J-Quants API ã®ä»•æ§˜æ›¸ãªã©ã¯ã“ã¡ã‚‰ã§ç¢ºèªã§ãã¾ã™ã€‚
https://jpx-jquants.com/auth/signin/?lang=ja
https://jpx.gitbook.io/j-quants-ja/api-reference

```r
library(tidyverse)
library(here)
library(arrow)
library(fs)
library(httr)
library(jsonlite)

get_header <- function() {
    r_post_refresh <- POST(
        url = "https://api.jquants.com/v1/token/auth_user",
        body = toJSON(jquant, auto_unbox = TRUE),
        encode = "json"
    )
    REFRESH_TOKEN <- content(r_post_refresh, as = "parsed", type = "application/json")

    r_post <- POST(
        url = str_c("https://api.jquants.com/v1/token/auth_refresh?refreshtoken=", REFRESH_TOKEN)
    )

    # Parse the JSON response
    idToken <- content(r_post, as = "parsed", type = "application/json")
    headers <- add_headers(Authorization = paste("Bearer", idToken))$headers
    return(headers)
}

fetch_data <- function(query, data_type, key, headers) {
    api_url <- "https://api.jquants.com"
    if (key == "") {
        path <- c("v1", data_type)
    } else {
        path <- c("v1", data_type, key)
    }
    url <- modify_url(api_url, path = path, query = query)
    response <- GET(url, add_headers(.headers = headers))
    stop_for_status(response)

    # Parse the JSON response
    parsed <- content(response, as = "text", encoding = "UTF-8") |> fromJSON()
    data <- parsed[[1]] |> tibble()
    return(data)
}

get_simple_data <- function(query, data_type, key, headers) {
    data <- fetch_data(query, data_type, key, headers)
    if (nrow(data) > 0) {
        data <- data |> mutate_all(~ str_replace_all(., "-", ""))
        return(data)
    }
}
get_fs_detail <- function(date, headers) {
    data <- fetch_data(list(date = date), "fins", "fs_details", headers)
    if (nrow(data) != 0) {
        data <- data |>
            unnest(FinancialStatement) |>
            pivot_longer(cols = -c(DisclosedDate, DisclosedTime, LocalCode, DisclosureNumber, TypeOfDocument))
        return(data)
    }
}

post_to_slack <- function(text, slack_url) {
    webhook_url <- slack_url
    payload <- list(text = text)
    POST(webhook_url, body = payload, encode = "json")
}

save_data <- function(dat, col_name) {
    if (!dir_exists(here("data"))) {
        dir_create(here("data"))
    }
    dat |>
        select({
            col_name
        }) |>
        unnest({
            col_name
        }) |>
        write_parquet(here(str_c("data/dat_", col_name, ".parquet")))
}

main <- function(flag_output, start_date, end_date) {
    start_time <- proc.time()
    source(here("data/authinfo.r"))
    start_date <- ymd(20241201)
    end_date <- ymd(20251031)

    headers <- get_header()
    dat_calendar <- fetch_data(list(holidaydivision = 1), "markets", "trading_calendar", headers) |>
        mutate(date_data = ymd(Date)) |>
        filter(date_data |> between(ymd(start_date), ymd(end_date))) |>
        select(-date_data)
    dat_all <- dat_calendar |>
        mutate(
            price = map(Date, ~ get_simple_data(list(date = .x), "prices", "daily_quotes", headers)),
            financials = map(Date, ~ get_simple_data(list(date = .x), "fins", "statements", headers)),
            listedinfo = map(Date, ~ get_simple_data(list(date = .x), "listed", "info", headers))
        )

    if (flag_output) {
        if (!dir_exists(here("data"))) {
            dir_create(here("data"))
        }
        dat_all |>
            select(price) |>
            unnest(price) |>
            write_parquet(here("data/dat_price.parquet"))
        dat_all |>
            select(financials) |>
            unnest(financials) |>
            write_parquet(here("data/dat_fin.parquet"))
        dat_all |>
            select(listedinfo) |>
            unnest(listedinfo) |>
            write_parquet(here("data/dat_info.parquet"))
        dat_all |> saveRDS(here("data/dat_all.rds"))
    }

    elapsed_minutes <- ((proc.time() - start_time) / 60)[[3]]
    message <- as.character(paste0(
        "downloading jquants data has done! in ",
        round(elapsed_minutes),
        " minutes"
    ))
    post_to_slack(message, slack_url)
}


get_premium_data <- function(flag_output) {
    # for premium plan
    start_time <- proc.time()
    source(here("data/authinfo.r"))

    headers <- get_header()
    dat_calendar <- fetch_data(list(holidaydivision = 1), "markets", "trading_calendar", headers)
    dat_all <- dat_calendar |>
        mutate(
            dividend = map(Date, ~ get_simple_data(list(date = .x), "fins", "dividend", headers)),
            options_price = map(Date, ~ get_simple_data(list(date = .x), "derivatives", "options", headers)),
            futures_price = map(Date, ~ get_simple_data(list(date = .x), "derivatives", "futures", headers)),
            index_value = map(Date, ~ get_simple_data(list(date = .x), "indices", "", headers)),
            fs_detail = map(Date, ~ get_fs_detail(.x, headers))
        )

    if (flag_output) {
        dat_all |> save_data("dividend")
        dat_all |> save_data("options_price")
        dat_all |> save_data("futures_price")
        dat_all |> save_data("fs_detail")
    }

    elapsed_minutes <- ((proc.time() - start_time) / 60)[[3]]
    message <- as.character(paste0(
        "downloading jquants data has done! in ",
        round(elapsed_minutes),
        " minutes"
    ))
    post_to_slack(message, slack_url)
}

# main(TRUE, 20250101, 20251031)
```

ãªã‚“ã‹ä¸­é€”åŠç«¯ã§æç¸®ã§ã™ãŒã€åˆã‚ã¦ã®è¨˜äº‹ã§ã™ã—ã‚€ã¡ã‚ƒãã¡ã‚ƒé•·ããªã£ã¦ã—ã¾ã£ãŸã®ã§ã„ã£ãŸã‚“ã“ã“ã¾ã§ã«ã—ã¾ã™ã€‚
